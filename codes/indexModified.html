<html>
  <head>
    <meta charset="UTF-8" />
    <title>First DApp Demo</title>
    <link rel="stylesheet" type="text/css" href="main.css" />
    <!-- <script src="js/web3.min.js"></script> -->
    <script src="https://unpkg.com/web3@latest/dist/web3.min.js"></script>
  </head>

  <body>
    <div class="container">
      <h1>First DApp Demo</h1>
      <h2 id="info"></h2>
      <label>姓名：</label>
      <input id="name" type="text" />
      <label>年龄：</label>
      <input id="age" type="text" />
      <button id="button">更新</button>
    </div>

    <script>

    if (window.ethereum) {
		  let web3Provider = window.ethereum;
		  window.ethereum.enable();
		  web3 = new Web3(web3Provider);
		console.log(web3.version.api);
       }
		

      var infoContract = new web3.eth.Contract([
        {
          constant: true,
          inputs: [],
          name: "getInfo",
          outputs: [
            {
              name: "",
              type: "string",
            },
            {
              name: "",
              type: "uint256",
            },
          ],
          payable: false,
          stateMutability: "view",
          type: "function",
        },
        {
          constant: false,
          inputs: [
            {
              name: "_name",
              type: "string",
            },
            {
              name: "_age",
              type: "uint256",
            },
          ],
          name: "setInfo",
          outputs: [],
          payable: false,
          stateMutability: "nonpayable",
          type: "function",
        },
      ]);
	  
	  var account;
		web3.eth.getAccounts(function (error, result) {
			if (!error)
			  console.log('101行，获取账号：',result[0])//授权成功后result能正常获取到账号了
			  console.log("103行，web3.version:",web3.version);
			  web3.eth.getBalance(result[0],(err, res) => {
				var b = "";
				if (!err) {
					b += res;
					this.txHash=res
				} else {
					b = "Error"+err;
				}
				console.log('113行，',result[0],'余额:',b);
				account=result[0];
			})
		});
      console.log(infoContract)
      // var info = infoContract.at("0xBEb9344a46c4A31a550A745BFB2135308f6E00fF",account);
      var info = infoContract.at("0xBEb9344a46c4A31a550A745BFB2135308f6E00fF",account);
      // web3.eth.defaultAccount = '0x11f4d0A3c12e86B4b5F39B213F7E19D048276DAe';
      var info = infoContract.defaultAccount

      info.getInfo(function (error, result) {
        if (!error) {
		console.log(result);
          $("#info").html(result[0] + " (" + result[1] + " years old)");
        } 
      });

      $("#button").click(function () {
        var name = $("#name").val();
        var age = $("#age").val();
        info.setInfo(name,age,function(error,result){
          if (!error) {
            console.log("set ok")
          }
        })
      });
    </script>
  </body>
</html>
